<!DOCTYPE html>
<html lang="ja">

<div class="nav">
  <button onclick="location.href='タイムスケジュール.html'">タイムスケジュール</button>
  <button onclick="location.href='シフト表.html'">シフト表</button>
  <button class="active" onclick="location.href='予約管理ページ.html'">予約管理</button>
  <button onclick="location.href='割引設定ページ.html'">割引設定ページ</button>
  <button onclick="location.href='キャストオプションリスト.html'">キャストオプションリスト</button>
</div>

<head>
  <meta charset="UTF-8">
  <title>日別予約管理（即時反映＋入退室＋金額自動計算）</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .date-tabs { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
    .date-tabs button {
      margin: 2px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    .date-tabs button.active {
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    .reservation-page { display: none; }
    .reservation-page.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 5px; font-size: 12px; text-align: center; vertical-align: middle; }
    th { background: #f2f2f2; }
    input, select, textarea, button { font-size: 12px; padding: 3px; }
    textarea { resize: vertical; }
    .time-select { display: flex; gap: 4px; justify-content: center; }
    .status-label { font-size: 12px; color: red; margin-left: 5px; }
  </style>
</head>
<body>
  <h2>日別予約管理（即時反映＋入退室＋金額自動計算）</h2>

  <!-- 月選択 -->
  <label>対象月: <input type="month" id="monthSelect" onchange="generateTabs()"></label>

  <div class="date-tabs" id="dateTabs"></div>
  <div id="pages"></div>

  <script>
    const maxReservations = 50;
    const hours = Array.from({length: 24}, (_,i)=>String(i).padStart(2,"0"));
    const minutes = Array.from({length: 60}, (_,i)=>String(i).padStart(2,"0"));

    const optionItems = ["", "ノーパン・ノーブラ派遣", "ストッキング破り", "コスプレ", "アイマスク", "電マ", "ローター", 
      "聖水", "バイブ", "即尺", "顏射", "ごっくん", "AF", 
      "顔無し動画", "顔有り動画", "写真撮影(1枚毎)", "顔有写真撮影取り放題", "顔無写真撮影取り放題"];

    const discountItems = ["", "新規割","新人割","フーコレ口コミ割+10分","ヘブン口コミ割","団体割","即姫割",
      "フーコレ口コミ初割","ヘブン口コミ初割","フリー割","兄貴割(達人)","兄貴割(強者)","兄貴割(猛者)","兄貴割(豪傑)","兄貴割(修羅)","兄貴割(風神)",
      "フーコレ無料券","フーコレ半額券","オーシャン7無料券","オーシャン7半額券","口コミ当選無料券","口コミ当選10000円券",
      "口コミ当選5000円券","口コミ当選3000円券","口コミ当選2000円券","会員限定新人割※アンケート","メルマガ合言葉+10分","10回に1回無料"];

    // 料金表
    const priceTable = {
      ST: {60:16000,70:16000,75:20000,85:20000,90:24000,100:24000,120:31000,130:31000,
           150:38000,160:38000,180:45000,190:45000,210:53000,220:53000,240:60000,250:60000,
           270:67000,280:67000,300:74000,310:74000,330:81000,340:81000,360:88000,370:88000,
           390:95000,400:95000,420:102000,430:102000,450:109000,460:109000,480:116000,490:116000,
           510:123000,520:123000,540:130000,550:130000,570:137000,580:137000},
      PG: {60:19000,70:19000,75:23000,85:23000,90:27000,100:27000,120:34000,130:34000,
           150:41000,160:41000,180:48000,190:48000,210:56000,220:56000,240:63000,250:63000,
           270:70000,280:70000,300:77000,310:77000,330:84000,340:84000,360:91000,370:91000,
           390:98000,400:98000,420:105000,430:105000,450:112000,460:112000,480:119000,490:119000,
           510:126000,520:126000,540:133000,550:133000,570:173000,580:173000}
    };

    function calcEndTime(start, courseMin) {
      if (!start || !courseMin) return "";
      const [h, m] = start.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return "";
      const d = new Date(2000,1,1,h,m);
      d.setMinutes(d.getMinutes() + parseInt(courseMin));
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // 金額計算
    function updateAmount(tr) {
      const plan = tr.querySelector("td:nth-child(4) select").value;
      const course = tr.querySelector("td:nth-child(8) select").value;
      const extend = tr.querySelector("td:nth-child(9) select").value;
      const type = tr.querySelector("td:nth-child(7) select").value;
      const transport = tr.querySelector("td:nth-child(11) select").value;
      const option = tr.querySelector("td:nth-child(13) select").value;
      const cast = tr.querySelector("td:nth-child(3) input").value;
      const discount = tr.querySelector("td:nth-child(12) select").value;

      const amountInput = tr.querySelector("td:last-child input");

      let amount = 0;

      if (priceTable[plan] && priceTable[plan][course]) {
        amount = priceTable[plan][course];
      }

      if (extend) {
        const extendMinutes = parseInt(extend);
        const extendUnit = (plan==="ST") ? 12000 : 14000;
        amount += (extendMinutes / 30) * extendUnit;
      }

      if (type === "本指名") amount += 1000;
      if (transport) amount += parseInt(transport);

      const discountMap = JSON.parse(localStorage.getItem("discountTable") || "{}");
      if (discount && course && discountMap[discount] && discountMap[discount][course]) {
        amount += discountMap[discount][course];
      }

      const optionMap = JSON.parse(localStorage.getItem("optionPriceMap") || "{}");
      if (cast && option && optionMap[cast] && optionMap[cast][option]) {
        amount += optionMap[cast][option];
      }

      amountInput.value = amount || "";
    }

    function enterRoom(tr) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      tr.querySelector(".hourSelect").value = hh;
      tr.querySelector(".minuteSelect").value = mm;
      tr.querySelector(".status-label").textContent = "接客中";

      const course = tr.querySelector("td:nth-child(8) select").value;
      if (course) {
        const end = calcEndTime(`${hh}:${mm}`, course);
        tr.querySelector(".endTime").value = end;
      }
      updateAmount(tr);
      autoApply();
    }

    function exitRoom(tr) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      tr.querySelector(".endTime").value = `${hh}:${mm}`;
      tr.querySelector(".status-label").textContent = "";
      updateAmount(tr);
      autoApply();
    }

    function createReservationRow(index, saved, dateStr) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index+1}</td>
        <td>
          <button type="button" class="enterBtn">入室</button>
          <button type="button" class="exitBtn">退出</button>
          <span class="status-label">${saved?.status||""}</span>
        </td>
        <td><input type="text" value="${saved?.cast||""}" placeholder="キャスト名"></td>
        <td>
          <select>
            <option ${saved?.plan==="ST"?"selected":""}>ST</option>
            <option ${saved?.plan==="PG"?"selected":""}>PG</option>
          </select>
        </td>
        <td class="time-select">
          <select class="hourSelect">${hours.map(h=>`<option value="${h}" ${saved?.start?.split(":")[0]==h?"selected":""}>${h}</option>`).join("")}</select>
          <select class="minuteSelect">${minutes.map(m=>`<option value="${m}" ${saved?.start?.split(":")[1]==m?"selected":""}>${m}</option>`).join("")}</select>
        </td>
        <td><input type="text" class="endTime" value="${saved?.end||""}" placeholder="終了時間"></td>
        <td>
          <select>
            <option ${saved?.type==="N指名"?"selected":""}>N指名</option>
            <option ${saved?.type==="本指名"?"selected":""}>本指名</option>
          </select>
        </td>
        <td>
          <select>
            <option value="">-</option>
            ${Object.keys(priceTable.ST).map(c=>`<option value="${c}" ${saved?.course==c?"selected":""}>${c}</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            <option value="">なし</option>
            ${[30,60,90,120,150].map(v=>`<option value="${v}" ${saved?.extend==v?"selected":""}>${v}分</option>`).join("")}
          </select>
        </td>
        <td><input type="text" value="${saved?.place||""}" placeholder="利用場所"></td>
        <td>
          <select>
            <option value="">なし</option>
            ${[1000,2000,3000,4000,5000].map(v=>`<option value="${v}" ${saved?.transport==v?"selected":""}>${v}円</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            ${discountItems.map(d=>`<option value="${d}" ${saved?.discount==d?"selected":""}>${d}</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            ${optionItems.map(o=>`<option value="${o}" ${saved?.option==o?"selected":""}>${o}</option>`).join("")}
          </select>
        </td>
        <td><input type="tel" value="${saved?.phone||""}" placeholder="電話番号"></td>
        <td><input type="text" value="${saved?.customer||""}" placeholder="顧客名"></td>
        <td><textarea rows="1" placeholder="備考">${saved?.note||""}</textarea></td>
        <td><input type="number" value="${saved?.amount||""}" placeholder="金額"></td>
      `;

      tr.querySelector(".enterBtn").addEventListener("click", ()=>enterRoom(tr));
      tr.querySelector(".exitBtn").addEventListener("click", ()=>exitRoom(tr));

      // 🔹 開始時間が入力されたら終了時間を自動計算
      tr.querySelectorAll("select,input,textarea").forEach(el=>{
        el.addEventListener("change", ()=>{
          updateAmount(tr);

          const hour = tr.querySelector(".hourSelect").value;
          const minute = tr.querySelector(".minuteSelect").value;
          const course = tr.querySelector("td:nth-child(8) select").value;
          if (hour && minute && course) {
            const end = calcEndTime(`${hour}:${minute}`, course);
            tr.querySelector(".endTime").value = end;
          }

          autoApply();
        });
        el.addEventListener("input", ()=>{ updateAmount(tr); autoApply(); });
      });

      return tr;
    }

    function createReservationPage(day, year, month) {
      const dateStr = `${year}-${String(month).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const div = document.createElement("div");
      div.className = "reservation-page";
      div.id = "day-" + day;
      div.innerHTML = `
        <h3>${dateStr} の予約管理</h3>
        <table>
          <thead>
            <tr>
              <th>No.</th><th>入退室</th><th>キャスト名</th><th>プラン</th><th>開始時間</th><th>終了時間</th>
              <th>指名種類</th><th>コース</th><th>延長</th><th>利用場所</th><th>交通費</th>
              <th>割引</th><th>オプション</th><th>電話番号</th><th>顧客名</th><th>備考</th><th>金額</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>`;
      const tbody = div.querySelector("tbody");
      const savedData = JSON.parse(localStorage.getItem("reservations_form_" + dateStr) || "[]");
      for (let i=0;i<maxReservations;i++) {
        tbody.appendChild(createReservationRow(i, savedData[i], dateStr));
      }
      return div;
    }

    function generateTabs() {
      const monthInput = document.getElementById("monthSelect").value;
      if (!monthInput) return;
      const [year, month] = monthInput.split("-");
      const daysInMonth = new Date(year, month, 0).getDate();

      const tabContainer = document.getElementById("dateTabs");
      const pagesContainer = document.getElementById("pages");
      tabContainer.innerHTML = "";
      pagesContainer.innerHTML = "";

      for (let d=1; d<=daysInMonth; d++) {
        const btn = document.createElement("button");
        btn.textContent = `${d}日`;
        btn.onclick = ()=>showPage(d, year, month);
        tabContainer.appendChild(btn);
        pagesContainer.appendChild(createReservationPage(d, year, month));
      }

      const lastDay = parseInt(localStorage.getItem("last_open_day")) || 1;
      showPage(lastDay, year, month);
    }

    function showPage(day, year, month) {
      document.querySelectorAll(".date-tabs button").forEach((b,i)=>b.classList.toggle("active",i+1===day));
      document.querySelectorAll(".reservation-page").forEach((p,i)=>p.classList.toggle("active",i+1===day));
      localStorage.setItem("last_open_day", day);
    }

    function autoApply() {
      const day = parseInt(localStorage.getItem("last_open_day")) || 1;
      const monthInput = document.getElementById("monthSelect").value;
      if (!monthInput) return;
      const [year, month] = monthInput.split("-");
      applyReservations(day, year, month, false);
    }

    function applyReservations(day, year, month, showAlert=true) {
      const dateStr = `${year}-${String(month).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const rows = document.querySelectorAll(`#day-${day} tbody tr`);

      let reservationsForTimeline = []; // タイムスケジュール用（黄色バー）
      let reservationsForForm = [];     // 入力フォーム用（キャスト名空でも残す）

      rows.forEach(row => {
        const reservation = {
          status: row.querySelector(".status-label").textContent || "",
          cast: row.querySelector("td:nth-child(3) input").value.trim(),
          plan: row.querySelector("td:nth-child(4) select").value,
          start: row.querySelector(".hourSelect").value+":"+row.querySelector(".minuteSelect").value,
          end: row.querySelector(".endTime").value,
          type: row.querySelector("td:nth-child(7) select").value,
          course: row.querySelector("td:nth-child(8) select").value,
          extend: row.querySelector("td:nth-child(9) select").value,
          place: row.querySelector("td:nth-child(10) input").value,
          transport: row.querySelector("td:nth-child(11) select").value,
          discount: row.querySelector("td:nth-child(12) select").value,
          option: row.querySelector("td:nth-child(13) select").value,
          phone: row.querySelector("td:nth-child(14) input").value,
          customer: row.querySelector("td:nth-child(15) input").value,
          note: row.querySelector("td:nth-child(16) textarea").value,
          amount: row.querySelector("td:nth-child(17) input").value
        };

        reservationsForForm.push(reservation);
        if (reservation.cast) {
          reservationsForTimeline.push(reservation);
        }
      });

      localStorage.setItem("reservations_" + dateStr, JSON.stringify(reservationsForTimeline));
      localStorage.setItem("reservations_form_" + dateStr, JSON.stringify(reservationsForForm));

      if (showAlert) alert(`${dateStr} の予約を保存しました！`);
    }

    window.addEventListener("load", ()=>{
      const now = new Date();
      document.getElementById("monthSelect").value =
        `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      generateTabs();
    });
  </script>
</body>
</html>
