<!DOCTYPE html>
<html lang="ja">

<div class="nav">
  <button onclick="location.href='ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«.html'">ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
  <button onclick="location.href='ã‚·ãƒ•ãƒˆè¡¨.html'">ã‚·ãƒ•ãƒˆè¡¨</button>
  <button class="active" onclick="location.href='äºˆç´„ç®¡ç†ãƒšãƒ¼ã‚¸.html'">äºˆç´„ç®¡ç†</button>
  <button onclick="location.href='å‰²å¼•è¨­å®šãƒšãƒ¼ã‚¸.html'">å‰²å¼•è¨­å®šãƒšãƒ¼ã‚¸</button>
  <button onclick="location.href='ã‚­ãƒ£ã‚¹ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ.html'">ã‚­ãƒ£ã‚¹ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ</button>
</div>

<head>
  <meta charset="UTF-8">
  <title>æ—¥åˆ¥äºˆç´„ç®¡ç†ï¼ˆå³æ™‚åæ˜ ï¼‹å…¥é€€å®¤ï¼‹é‡‘é¡è‡ªå‹•è¨ˆç®—ï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .date-tabs { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
    .date-tabs button {
      margin: 2px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    .date-tabs button.active {
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    .reservation-page { display: none; }
    .reservation-page.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 5px; font-size: 12px; text-align: center; vertical-align: middle; }
    th { background: #f2f2f2; }
    input, select, textarea, button { font-size: 12px; padding: 3px; }
    textarea { resize: vertical; }
    .time-select { display: flex; gap: 4px; justify-content: center; }
    .status-label { font-size: 12px; color: red; margin-left: 5px; }
  </style>
</head>
<body>
  <h2>æ—¥åˆ¥äºˆç´„ç®¡ç†ï¼ˆå³æ™‚åæ˜ ï¼‹å…¥é€€å®¤ï¼‹é‡‘é¡è‡ªå‹•è¨ˆç®—ï¼‰</h2>

  <!-- æœˆé¸æŠ -->
  <label>å¯¾è±¡æœˆ: <input type="month" id="monthSelect" onchange="generateTabs()"></label>

  <div class="date-tabs" id="dateTabs"></div>
  <div id="pages"></div>

  <script>
    const maxReservations = 50;
    const hours = Array.from({length: 24}, (_,i)=>String(i).padStart(2,"0"));
    const minutes = Array.from({length: 60}, (_,i)=>String(i).padStart(2,"0"));

    const optionItems = ["", "ãƒãƒ¼ãƒ‘ãƒ³ãƒ»ãƒãƒ¼ãƒ–ãƒ©æ´¾é£", "ã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°ç ´ã‚Š", "ã‚³ã‚¹ãƒ—ãƒ¬", "ã‚¢ã‚¤ãƒã‚¹ã‚¯", "é›»ãƒ", "ãƒ­ãƒ¼ã‚¿ãƒ¼", 
      "è–æ°´", "ãƒã‚¤ãƒ–", "å³å°º", "é¡å°„", "ã”ã£ãã‚“", "AF", 
      "é¡”ç„¡ã—å‹•ç”»", "é¡”æœ‰ã‚Šå‹•ç”»", "å†™çœŸæ’®å½±(1æšæ¯)", "é¡”æœ‰å†™çœŸæ’®å½±å–ã‚Šæ”¾é¡Œ", "é¡”ç„¡å†™çœŸæ’®å½±å–ã‚Šæ”¾é¡Œ"];

    const discountItems = ["", "æ–°è¦å‰²","æ–°äººå‰²","ãƒ•ãƒ¼ã‚³ãƒ¬å£ã‚³ãƒŸå‰²+10åˆ†","ãƒ˜ãƒ–ãƒ³å£ã‚³ãƒŸå‰²","å›£ä½“å‰²","å³å§«å‰²",
      "ãƒ•ãƒ¼ã‚³ãƒ¬å£ã‚³ãƒŸåˆå‰²","ãƒ˜ãƒ–ãƒ³å£ã‚³ãƒŸåˆå‰²","ãƒ•ãƒªãƒ¼å‰²","å…„è²´å‰²(é”äºº)","å…„è²´å‰²(å¼·è€…)","å…„è²´å‰²(çŒ›è€…)","å…„è²´å‰²(è±ªå‚‘)","å…„è²´å‰²(ä¿®ç¾…)","å…„è²´å‰²(é¢¨ç¥)",
      "ãƒ•ãƒ¼ã‚³ãƒ¬ç„¡æ–™åˆ¸","ãƒ•ãƒ¼ã‚³ãƒ¬åŠé¡åˆ¸","ã‚ªãƒ¼ã‚·ãƒ£ãƒ³7ç„¡æ–™åˆ¸","ã‚ªãƒ¼ã‚·ãƒ£ãƒ³7åŠé¡åˆ¸","å£ã‚³ãƒŸå½“é¸ç„¡æ–™åˆ¸","å£ã‚³ãƒŸå½“é¸10000å††åˆ¸",
      "å£ã‚³ãƒŸå½“é¸5000å††åˆ¸","å£ã‚³ãƒŸå½“é¸3000å††åˆ¸","å£ã‚³ãƒŸå½“é¸2000å††åˆ¸","ä¼šå“¡é™å®šæ–°äººå‰²â€»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ","ãƒ¡ãƒ«ãƒã‚¬åˆè¨€è‘‰+10åˆ†","10å›ã«1å›ç„¡æ–™"];

    // æ–™é‡‘è¡¨
    const priceTable = {
      ST: {60:16000,70:16000,75:20000,85:20000,90:24000,100:24000,120:31000,130:31000,
           150:38000,160:38000,180:45000,190:45000,210:53000,220:53000,240:60000,250:60000,
           270:67000,280:67000,300:74000,310:74000,330:81000,340:81000,360:88000,370:88000,
           390:95000,400:95000,420:102000,430:102000,450:109000,460:109000,480:116000,490:116000,
           510:123000,520:123000,540:130000,550:130000,570:137000,580:137000},
      PG: {60:19000,70:19000,75:23000,85:23000,90:27000,100:27000,120:34000,130:34000,
           150:41000,160:41000,180:48000,190:48000,210:56000,220:56000,240:63000,250:63000,
           270:70000,280:70000,300:77000,310:77000,330:84000,340:84000,360:91000,370:91000,
           390:98000,400:98000,420:105000,430:105000,450:112000,460:112000,480:119000,490:119000,
           510:126000,520:126000,540:133000,550:133000,570:173000,580:173000}
    };

    function calcEndTime(start, courseMin) {
      if (!start || !courseMin) return "";
      const [h, m] = start.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return "";
      const d = new Date(2000,1,1,h,m);
      d.setMinutes(d.getMinutes() + parseInt(courseMin));
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // é‡‘é¡è¨ˆç®—
    function updateAmount(tr) {
      const plan = tr.querySelector("td:nth-child(4) select").value;
      const course = tr.querySelector("td:nth-child(8) select").value;
      const extend = tr.querySelector("td:nth-child(9) select").value;
      const type = tr.querySelector("td:nth-child(7) select").value;
      const transport = tr.querySelector("td:nth-child(11) select").value;
      const option = tr.querySelector("td:nth-child(13) select").value;
      const cast = tr.querySelector("td:nth-child(3) input").value;
      const discount = tr.querySelector("td:nth-child(12) select").value;

      const amountInput = tr.querySelector("td:last-child input");

      let amount = 0;

      if (priceTable[plan] && priceTable[plan][course]) {
        amount = priceTable[plan][course];
      }

      if (extend) {
        const extendMinutes = parseInt(extend);
        const extendUnit = (plan==="ST") ? 12000 : 14000;
        amount += (extendMinutes / 30) * extendUnit;
      }

      if (type === "æœ¬æŒ‡å") amount += 1000;
      if (transport) amount += parseInt(transport);

      const discountMap = JSON.parse(localStorage.getItem("discountTable") || "{}");
      if (discount && course && discountMap[discount] && discountMap[discount][course]) {
        amount += discountMap[discount][course];
      }

      const optionMap = JSON.parse(localStorage.getItem("optionPriceMap") || "{}");
      if (cast && option && optionMap[cast] && optionMap[cast][option]) {
        amount += optionMap[cast][option];
      }

      amountInput.value = amount || "";
    }

    function enterRoom(tr) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      tr.querySelector(".hourSelect").value = hh;
      tr.querySelector(".minuteSelect").value = mm;
      tr.querySelector(".status-label").textContent = "æ¥å®¢ä¸­";

      const course = tr.querySelector("td:nth-child(8) select").value;
      if (course) {
        const end = calcEndTime(`${hh}:${mm}`, course);
        tr.querySelector(".endTime").value = end;
      }
      updateAmount(tr);
      autoApply();
    }

    function exitRoom(tr) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      tr.querySelector(".endTime").value = `${hh}:${mm}`;
      tr.querySelector(".status-label").textContent = "";
      updateAmount(tr);
      autoApply();
    }

    function createReservationRow(index, saved, dateStr) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index+1}</td>
        <td>
          <button type="button" class="enterBtn">å…¥å®¤</button>
          <button type="button" class="exitBtn">é€€å‡º</button>
          <span class="status-label">${saved?.status||""}</span>
        </td>
        <td><input type="text" value="${saved?.cast||""}" placeholder="ã‚­ãƒ£ã‚¹ãƒˆå"></td>
        <td>
          <select>
            <option ${saved?.plan==="ST"?"selected":""}>ST</option>
            <option ${saved?.plan==="PG"?"selected":""}>PG</option>
          </select>
        </td>
        <td class="time-select">
          <select class="hourSelect">${hours.map(h=>`<option value="${h}" ${saved?.start?.split(":")[0]==h?"selected":""}>${h}</option>`).join("")}</select>
          <select class="minuteSelect">${minutes.map(m=>`<option value="${m}" ${saved?.start?.split(":")[1]==m?"selected":""}>${m}</option>`).join("")}</select>
        </td>
        <td><input type="text" class="endTime" value="${saved?.end||""}" placeholder="çµ‚äº†æ™‚é–“"></td>
        <td>
          <select>
            <option ${saved?.type==="NæŒ‡å"?"selected":""}>NæŒ‡å</option>
            <option ${saved?.type==="æœ¬æŒ‡å"?"selected":""}>æœ¬æŒ‡å</option>
          </select>
        </td>
        <td>
          <select>
            <option value="">-</option>
            ${Object.keys(priceTable.ST).map(c=>`<option value="${c}" ${saved?.course==c?"selected":""}>${c}</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            <option value="">ãªã—</option>
            ${[30,60,90,120,150].map(v=>`<option value="${v}" ${saved?.extend==v?"selected":""}>${v}åˆ†</option>`).join("")}
          </select>
        </td>
        <td><input type="text" value="${saved?.place||""}" placeholder="åˆ©ç”¨å ´æ‰€"></td>
        <td>
          <select>
            <option value="">ãªã—</option>
            ${[1000,2000,3000,4000,5000].map(v=>`<option value="${v}" ${saved?.transport==v?"selected":""}>${v}å††</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            ${discountItems.map(d=>`<option value="${d}" ${saved?.discount==d?"selected":""}>${d}</option>`).join("")}
          </select>
        </td>
        <td>
          <select>
            ${optionItems.map(o=>`<option value="${o}" ${saved?.option==o?"selected":""}>${o}</option>`).join("")}
          </select>
        </td>
        <td><input type="tel" value="${saved?.phone||""}" placeholder="é›»è©±ç•ªå·"></td>
        <td><input type="text" value="${saved?.customer||""}" placeholder="é¡§å®¢å"></td>
        <td><textarea rows="1" placeholder="å‚™è€ƒ">${saved?.note||""}</textarea></td>
        <td><input type="number" value="${saved?.amount||""}" placeholder="é‡‘é¡"></td>
      `;

      tr.querySelector(".enterBtn").addEventListener("click", ()=>enterRoom(tr));
      tr.querySelector(".exitBtn").addEventListener("click", ()=>exitRoom(tr));

      // ğŸ”¹ é–‹å§‹æ™‚é–“ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰çµ‚äº†æ™‚é–“ã‚’è‡ªå‹•è¨ˆç®—
      tr.querySelectorAll("select,input,textarea").forEach(el=>{
        el.addEventListener("change", ()=>{
          updateAmount(tr);

          const hour = tr.querySelector(".hourSelect").value;
          const minute = tr.querySelector(".minuteSelect").value;
          const course = tr.querySelector("td:nth-child(8) select").value;
          if (hour && minute && course) {
            const end = calcEndTime(`${hour}:${minute}`, course);
            tr.querySelector(".endTime").value = end;
          }

          autoApply();
        });
        el.addEventListener("input", ()=>{ updateAmount(tr); autoApply(); });
      });

      return tr;
    }

    function createReservationPage(day, year, month) {
      const dateStr = `${year}-${String(month).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const div = document.createElement("div");
      div.className = "reservation-page";
      div.id = "day-" + day;
      div.innerHTML = `
        <h3>${dateStr} ã®äºˆç´„ç®¡ç†</h3>
        <table>
          <thead>
            <tr>
              <th>No.</th><th>å…¥é€€å®¤</th><th>ã‚­ãƒ£ã‚¹ãƒˆå</th><th>ãƒ—ãƒ©ãƒ³</th><th>é–‹å§‹æ™‚é–“</th><th>çµ‚äº†æ™‚é–“</th>
              <th>æŒ‡åç¨®é¡</th><th>ã‚³ãƒ¼ã‚¹</th><th>å»¶é•·</th><th>åˆ©ç”¨å ´æ‰€</th><th>äº¤é€šè²»</th>
              <th>å‰²å¼•</th><th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th><th>é›»è©±ç•ªå·</th><th>é¡§å®¢å</th><th>å‚™è€ƒ</th><th>é‡‘é¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>`;
      const tbody = div.querySelector("tbody");
      const savedData = JSON.parse(localStorage.getItem("reservations_form_" + dateStr) || "[]");
      for (let i=0;i<maxReservations;i++) {
        tbody.appendChild(createReservationRow(i, savedData[i], dateStr));
      }
      return div;
    }

    function generateTabs() {
      const monthInput = document.getElementById("monthSelect").value;
      if (!monthInput) return;
      const [year, month] = monthInput.split("-");
      const daysInMonth = new Date(year, month, 0).getDate();

      const tabContainer = document.getElementById("dateTabs");
      const pagesContainer = document.getElementById("pages");
      tabContainer.innerHTML = "";
      pagesContainer.innerHTML = "";

      for (let d=1; d<=daysInMonth; d++) {
        const btn = document.createElement("button");
        btn.textContent = `${d}æ—¥`;
        btn.onclick = ()=>showPage(d, year, month);
        tabContainer.appendChild(btn);
        pagesContainer.appendChild(createReservationPage(d, year, month));
      }

      const lastDay = parseInt(localStorage.getItem("last_open_day")) || 1;
      showPage(lastDay, year, month);
    }

    function showPage(day, year, month) {
      document.querySelectorAll(".date-tabs button").forEach((b,i)=>b.classList.toggle("active",i+1===day));
      document.querySelectorAll(".reservation-page").forEach((p,i)=>p.classList.toggle("active",i+1===day));
      localStorage.setItem("last_open_day", day);
    }

    function autoApply() {
      const day = parseInt(localStorage.getItem("last_open_day")) || 1;
      const monthInput = document.getElementById("monthSelect").value;
      if (!monthInput) return;
      const [year, month] = monthInput.split("-");
      applyReservations(day, year, month, false);
    }

    function applyReservations(day, year, month, showAlert=true) {
      const dateStr = `${year}-${String(month).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const rows = document.querySelectorAll(`#day-${day} tbody tr`);

      let reservationsForTimeline = []; // ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ï¼ˆé»„è‰²ãƒãƒ¼ï¼‰
      let reservationsForForm = [];     // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼ˆã‚­ãƒ£ã‚¹ãƒˆåç©ºã§ã‚‚æ®‹ã™ï¼‰

      rows.forEach(row => {
        const reservation = {
          status: row.querySelector(".status-label").textContent || "",
          cast: row.querySelector("td:nth-child(3) input").value.trim(),
          plan: row.querySelector("td:nth-child(4) select").value,
          start: row.querySelector(".hourSelect").value+":"+row.querySelector(".minuteSelect").value,
          end: row.querySelector(".endTime").value,
          type: row.querySelector("td:nth-child(7) select").value,
          course: row.querySelector("td:nth-child(8) select").value,
          extend: row.querySelector("td:nth-child(9) select").value,
          place: row.querySelector("td:nth-child(10) input").value,
          transport: row.querySelector("td:nth-child(11) select").value,
          discount: row.querySelector("td:nth-child(12) select").value,
          option: row.querySelector("td:nth-child(13) select").value,
          phone: row.querySelector("td:nth-child(14) input").value,
          customer: row.querySelector("td:nth-child(15) input").value,
          note: row.querySelector("td:nth-child(16) textarea").value,
          amount: row.querySelector("td:nth-child(17) input").value
        };

        reservationsForForm.push(reservation);
        if (reservation.cast) {
          reservationsForTimeline.push(reservation);
        }
      });

      localStorage.setItem("reservations_" + dateStr, JSON.stringify(reservationsForTimeline));
      localStorage.setItem("reservations_form_" + dateStr, JSON.stringify(reservationsForForm));

      if (showAlert) alert(`${dateStr} ã®äºˆç´„ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
    }

    window.addEventListener("load", ()=>{
      const now = new Date();
      document.getElementById("monthSelect").value =
        `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      generateTabs();
    });
  </script>
</body>
</html>
